# Maintainer: leap123 <leap123@canaglie.org>
pkgname=linux-postmarketos-rockchip-rk322x
pkgver=6.6.102
pkgrel=0
pkgdesc="Rockchip RK322X kernel package"
arch="armv7"
_carch="arm"
_flavor="${pkgname#linux-}"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	bash
	bc
	bison
	devicepkg-dev
	findutils
	flex
	openssl-dev
	perl
	postmarketos-installkernel
	xz
	zstd
"

# Source
_config="config-$_flavor.$arch"
case $pkgver in
	*.*.*)	_kernver=${pkgver%.0};;
	*.*)	_kernver=$pkgver;;
esac

# Most of the patches are taken from Armbian and ilmich's LibreELEC port
# https://github.com/armbian/build
# https://github.com/rk-unofficial-cfw/LibreELEC.tv/tree/le12-rk322x-wip
source="
	https://cdn.kernel.org/pub/linux/kernel/v${_kernver%%.*}.x/linux-$_kernver.tar.xz
	$_config
	0002-rockchip-from-list.patch
	0011-v4l2-from-list.patch
	0020-drm-from-list.patch
	1000-drm-rockchip.patch
	1000-rockchip-wip.patch
	1001-drm-wip.patch
	1001-v4l2-rockchip.patch
	1002-for-libreelec.patch
	1002-v4l-wip.patch
	2000-v4l2-wip-rkvdec-hevc.patch
	2001-v4l2-wip-iep-driver.patch
	4001-fix-ddr-clock-gate-add-SIP-v2-calls.patch
	4002-rk322x-analog-audio-codec.patch
	4003-add-bcm43342-chip.patch
	4003-add-ddr-clock-and-SIP-related-constant.patch
	4003-extend-rockchip-dfi-driver.patch
	4004-add-dmc-driver.patch
	4009-rk322x-composite-mmc-clk.patch
	4010-rk322x-gpio-ir-driver.patch
	9000-rk322x-dts.patch
	9001-a95xr1-dts.patch
	9003-fix-dmc-suspend-ddr2.patch
	9004-wip-audio-passtrough.patch
	9006-led-enable-at-shutdown.patch
	9007-lima-fix-null-pointer-dereference.patch
	9008-dw-mmc-set-name-of-irq.patch
"
builddir="$srcdir/linux-$_kernver"

prepare() {
	default_prepare
	cp "$srcdir/config-$_flavor.$CARCH" .config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-$_flavor"
}

package() {
	mkdir -p "$pkgdir"/boot
	make zinstall modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_PATH="$pkgdir"/boot \
		INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs
	rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

	install -D "$builddir"/include/config/kernel.release \
		"$pkgdir"/usr/share/kernel/$_flavor/kernel.release
}

sha512sums="
638b42029a92d1406e70ea2cafa8f3f7645785e4c6750e6d71eec6ba85b0c2be9f32fe63779b5b66cae3a85b4e3ac1b90abd90e667d88633e998a06ce4d3065d  linux-6.6.102.tar.xz
066b69b2f34c0a3b844ff7ee0174cefc35e00619ec5a333959f5c8c046e706b1b9b358cd3432eda22694bc55fb452ebce004984dd0042e1c2e6592d131bfbaf0  config-postmarketos-rockchip-rk322x.armv7
eba4e26dbda02d8250d92b9d8991ab688ff87c3a2e00271e2fd277769656e2568c8978254e3bbdcbc92e384e28d4341dbcb85e39d329e85421e84785c5a26060  0002-rockchip-from-list.patch
caba86ec7b7ffb0f58b999daa83fba588df9962d9a731bce1f3d08d905451947087ebe1a4be748df05f1b6b70bbedf27edbae6f1cbbdd685272d2400b0428ab6  0011-v4l2-from-list.patch
1f33ffa48aa95ae8e5d5dd0950499e06e1c12af7071ce2b1a4ade03b18c9529a368f2179b2b7064317e398248e1348fa882149878a2a10282dafe3331bc5f09c  0020-drm-from-list.patch
7c1e5d14beb0105d5cbca17cd126e3136aac885dbdfd33bcc327667813ca999c1a1a3ee1decf3b4a897af77400e16fa77abd3a87a4eceb951563ed06dfc34b65  1000-drm-rockchip.patch
8b2ae0742675da28f6bd590aa4d1531f263f414bfbc79d4145f5b684d038b7f8a2fad2aa4e80c20f92b8e9fa96b80493b0996824adcec0f3455fcf9bf826beb4  1000-rockchip-wip.patch
6ffc57ef13c977899ac05b6ad480661065d574d5d9e2ebb061b865147408b0232fa5f639b27c0c6edd8038d1249ad9c2822abca51b854713f243250caa608d75  1001-drm-wip.patch
451a993447262a3f6024d2890277f1a781bac34209d8373ea9557f80357d93bc17b2a1b53bde7771b5c5fe7d797508a4f2054ac23961f6207ff1185a4d39a2d6  1001-v4l2-rockchip.patch
d4919c809d6a2ea5ec0e75b41645c397765fbb269d18de1ea0c417c99a05f39873e8083aa8f70d12e803e463be3a3f9aa8435dea829ac5ce455b163c1eef6617  1002-for-libreelec.patch
813614651fdf60d5689603c4778160e8689cbd6ab1317498b3653d0e39b94d116ff2acf420a67a4058292a8b269e4525f1722d7d9b4ac37d2d4707b848fc6b7f  1002-v4l-wip.patch
c6f11ccdacafded8f01d38ff00d268573611e2e6f5f7e8da276253e74c0bb203c77804d275e5592ba63010f07bdb33e73539b6d3263438deaf487a16d59b5351  2000-v4l2-wip-rkvdec-hevc.patch
c0ef9ca3438db54ef35647d652a36d541d9c3c8d7140164b84e9ec3b524ff06cfc77fbf803520039550e74f1b6c70070f8755dd3c3904461d6c57fad884c276a  2001-v4l2-wip-iep-driver.patch
dfc6b72899b863130632bd9afd352eefb76216137bc8eda02489bb787a08f4f9cd5045bf58303c139c50104b8a27a9f442d3967a6def0fce0c5a271699161ace  4001-fix-ddr-clock-gate-add-SIP-v2-calls.patch
402a81c62cc87f0dd254007b97e7728337ab28746066a2e497ab098318e8c1b0d23fbcbc694bf2d1e53c864cb0bc1ebeb57a5f11a7a690b1e45e721f9596633d  4002-rk322x-analog-audio-codec.patch
0a70e945c7fc312612bb311b492755acce8f5764fbfe56f5063f068c8c690f837e1cefc40586978a163099984d64b46dbda0455f08cc2343bf7dad07bfc5c383  4003-add-bcm43342-chip.patch
9e02e9f71ed87af9779524a6d42679b88c4867b53ecdf6b809f5dda1ab4cae36fa8c063da82181421e4dc552b6006b7a737d8004984e3ed6bff2ebd3cb6f9ae2  4003-add-ddr-clock-and-SIP-related-constant.patch
33860cab1d6eee7df8d2c2a49bda52d300507c486e61e1237f048045c8f4bd562ea01f3aec3637510dc623c0cbed815112771436e79a58b7bf823dfc8f803a03  4003-extend-rockchip-dfi-driver.patch
f2227244c52316f9a667a4f6c589d21e3e5fa9147fe1203c53741b631c53c81715de35f6b2b158d3a3d99fbe0b095fe202194dc8b9fe9804063da94f77241bbf  4004-add-dmc-driver.patch
34595ed17ccc773a79ba21602e7bc350fcd859c4ab50453fd5209a709439e03ef7ad2a0335344a2aaf18652f15449415a2883444dfedee9a8fd0612a7966cf50  4009-rk322x-composite-mmc-clk.patch
ed2c493b2f4e95010a3f82bad7b347ef6871dee3b828682e46574379faadc73976c99b8b60eb76a48571943d16cbc606b6ea10c4f8d095e541903d6919bca553  4010-rk322x-gpio-ir-driver.patch
18069043b29e4fce9c500c52857aea5ee966bfe37f7fe32dacf9cf78b139ba56cfadadae6ac41ad5a60f9480579f5d04ca32ae44b2c5501b07133fefcfa6ffb4  9000-rk322x-dts.patch
c0fe7f3a46415b097338bd0a2b674db772f72b86fc1c7e5b1db6859e49e12bdcc326b2b16090e539eca14ceab9f559b5e6e32374b4f1f9c89896453f398f11b7  9001-a95xr1-dts.patch
e0ea268eabdbeb382db0f23518d2c9020b3e357560cd175719f89f0b1e34272095516d8870d33cb2d459fedadf5154cf87a61de93bcbc84d831d1077b4302e72  9003-fix-dmc-suspend-ddr2.patch
91fb6b809401537a5ff648cba1d4e7a7f6730696059f3acce965c350c8e336a1d2092d128967a40731bec2dba479d4b50d657ab435d649f53faff25537ebdcaf  9004-wip-audio-passtrough.patch
2d9c8238406a1e2ded3703aa7c26227b170e2c4d19757b4fe499690ce2bb2d1eba8b1f01d21a5bee623e047217550c86ac614f9bd75c15d032444319a26bd749  9006-led-enable-at-shutdown.patch
a80265439dd2f57a8b93f0e7ceb2544718603a55db9dd3fddb85d90f90f648284ca7f0194847211da016c5be612d8c42ede5b33c79afeffedfef9653d06efa13  9007-lima-fix-null-pointer-dereference.patch
69826d24021ab408fca49cee3a91a0e190a51a475ec9163f372fc592b58cbd6cef32cf57d0cb53316e72ee4feec5c8d941242e8f0b6e2638d35f5bdb8188bf08  9008-dw-mmc-set-name-of-irq.patch
"
