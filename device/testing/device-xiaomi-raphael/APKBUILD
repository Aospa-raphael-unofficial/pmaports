# Reference: <https://postmarketos.org/devicepkg>
pkgname=device-xiaomi-raphael
pkgdesc="Xiaomi Mi 9T Pro / Redmi K20 Pro"
pkgver=3
pkgrel=2
url="https://postmarketos.org"
license="MIT"
arch="aarch64"
_carch="arm64"
options="
	!check
	!archcheck
	!strip
	"
depends="
	linux-xiaomi-raphael
	mkbootimg
	postmarketos-base
	mesa-vulkan-freedreno
	msm-modem
"
makedepends="devicepkg-dev"
source="
	deviceinfo
	modules-initfs
	HiFi.conf
	raphael.pa
	89-xiaomi_raphael.conf
	XiaomiRaphael.conf
"

subpackages="
	$pkgname-audio
	$pkgname-nonfree-firmware:nonfree_firmware
	$pkgname-nonfree-firmware-openrc:nonfree_firmware_openrc
"

build() {
	devicepkg_build $startdir $pkgname
}

package() {
	devicepkg_package $startdir $pkgname

	install -Dm644 "$srcdir/XiaomiRaphael.conf" -c \
		"$pkgdir/usr/share/alsa/ucm2/conf.d/sm8150/Xiaomi Raphael.conf"

	install -Dm644 "$srcdir"/89-xiaomi_raphael.conf -t \
		"$pkgdir"/etc/pulse/daemon.conf.d

	install -Dm644 "$srcdir"/raphael.pa -t \
		"$pkgdir"/etc/pulse/default.pa.d

	install -Dm644 "$srcdir"/HiFi.conf -t \
		"$pkgdir"/usr/share/alsa/ucm2/Xiaomi/raphael
}

nonfree_firmware() {
	pkgdesc="Firmware for GPU, WiFi, etc."
	depends="
		firmware-xiaomi-raphael
		firmware-xiaomi-raphael-adreno
		firmware-xiaomi-raphael-adsp
		firmware-xiaomi-raphael-camera
		firmware-xiaomi-raphael-cdsp
		firmware-xiaomi-raphael-ipa
		firmware-xiaomi-raphael-slpi
		firmware-xiaomi-raphael-modem
		firmware-xiaomi-raphael-touchscreen
		firmware-xiaomi-raphael-venus
		firmware-xiaomi-raphael-wlan
		linux-firmware-ath11k
		linux-firmware-qcom
		msm-modem
		pd-mapper
		tqftpserv
"
	mkdir "$subpkgdir"
}

nonfree_firmware_openrc() {
	install_if="$pkgname-nonfree-firmware=$pkgver-r$pkgrel openrc"
	install="$subpkgname.post-install"
	depends="openrc"

	mkdir "$subpkgdir"
}

audio() {
	install_if="$pkgname=$pkgver-r$pkgrel postmarketos-base-ui-audio"
	replaces="alsa-ucm-conf"
	depends="
		alsa-ucm-conf
		postmarketos-base-ui-audio-pipewire
		pulseaudio
	"

	amove "usr/share/alsa/ucm2/conf.d/sm8150/Xiaomi Raphael.conf"
	amove etc/pulse/daemon.conf.d
	amove etc/pulse/default.pa.d
	amove usr/share/alsa/ucm2/Xiaomi/raphael
}

sha512sums="
a758db7a78a830f9e3959f2123d62d8ce07d222e17c6f82288c950c6bf26449bbbefb21164f7f3f9072b04fa3455e83ea681cca31d74390f78d4e4eaf5f7b789  deviceinfo
d81350bb2c594d1c922b4eaa5f7ddd94ff5c52d915b6b34e01be2fddc5d624dea77343fab9b168acf889b55daa80a5deace6b81366d579816d5cc73b543a6826  modules-initfs
522c784bd0facddd72b64cac78367fd35bab55d7aadc5bc1480d71d60bc58ae07fcc20ecf99268db5c345ea092e427623ed60cdd0279bd2344e26a79bd38ab98  HiFi.conf
26690cbbe2fd2c89becef3d6c87f7b770720423c6ea17136d74305afafad4d66b3a889f9afebaba7aa9acbae638e4687ea96f2989b7cde1b8ce4da0103fb51ac  raphael.pa
e3a41af12fc6af9942fa3fa15211cd5ed2bf5d9b2b9e9933dca71ae3b24d0a9125394ea3c9a9db70f0d574f7fe85c212aada36932d7c970159f693d92e804071  89-xiaomi_raphael.conf
bf667e09304e6d1b78a50fa63a584fa5f9ef474a1b4fcfc6b1639388453d49630772b72b8a41a1b54efcbf89058f20cf3b0e82784903689063308111a266d794  XiaomiRaphael.conf
"
