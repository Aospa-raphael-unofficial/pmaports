# Maintainer: Piyush Raj Chouhan <piyushchouhan1598@gmail.com>
_flavor="xiaomi-raphael"
pkgname=linux-$_flavor
pkgver=6.16.0
pkgrel=1
pkgdesc="Xiaomi Mi 9T Pro / Redmi K20 Pro kernel fork"
arch="aarch64"
_carch="arm64"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps
    pmb:cross-native
    pmb:kconfigcheck-nftables
    "
makedepends="
    bash
    bison
    findutils
    flex
    linux-headers
    openssl-dev
    perl
    postmarketos-installkernel
    python3
    "

_config="config-$_flavor.$arch"
_commit="090d21dc9212e7b520178d26dd60a6edebfcacb1"
source="
    $pkgname-$_commit.tar.gz::https://github.com/Aospa-raphael-unofficial/linux/archive/$_commit.tar.gz
    $_config
"
builddir="$srcdir/linux-$_commit"

prepare() {
    default_prepare
    cp "$srcdir/config-$_flavor.$arch" .config
}

build() {
    unset LDFLAGS
    make -j$(nproc) ARCH="$_carch" CC="${CC:-gcc}" \
        KBUILD_BUILD_VERSION="$((pkgrel + 1))-postmarketOS"
}

package() {
    mkdir -p "$pkgdir"/boot

    # Install modules and DTBs
    make zinstall modules_install dtbs_install \
        ARCH="$_carch" \
	INSTALL_PATH="$pkgdir"/boot/ \
        INSTALL_MOD_PATH="$pkgdir" \
        INSTALL_MOD_STRIP=1 \
        INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs

    rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

    install -D "$builddir/include/config/kernel.release" \
        "$pkgdir"/usr/share/kernel/$_flavor/kernel.release
}

sha512sums="
5d642fb108c26a7b786b5a1d071daa2219efa57f74db83446ecf54a5d17197f585f3f05102e85fde3e8de86e51333576cf83736fb05dd002a5fdf694f9bc1b61  linux-xiaomi-raphael-090d21dc9212e7b520178d26dd60a6edebfcacb1.tar.gz
b776c5b11bb9021b341a72195838066a3f50cb7fad235ac8f53b3e6398ef0cdd2cb00ff058d5308917959a7500d501d54c718100c5227a9b957627c7d414d4ed  config-xiaomi-raphael.aarch64
"
