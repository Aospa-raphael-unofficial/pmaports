# Maintainer: Piyush Raj Chouhan <piyushchouhan1598@gmail.com>
_flavor="xiaomi-raphael"
pkgname=linux-$_flavor
pkgver=6.14.0
pkgrel=1
pkgdesc="Xiaomi Mi 9T Pro / Redmi K20 Pro kernel fork"
arch="aarch64"
_carch="arm64"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps
    pmb:cross-native
    pmb:kconfigcheck-nftables
    "
makedepends="
    bash
    bison
    findutils
    flex
    linux-headers
    openssl-dev
    perl
    postmarketos-installkernel
    python3
    "

_config="config-$_flavor.$arch"
_commit="acf0a3647abf06f35b9fed72ba5b76309ac2c42c"
source="
    $pkgname-$_commit.tar.gz::https://github.com/Aospa-raphael-unofficial/linux/archive/$_commit.tar.gz
    $_config
"
builddir="$srcdir/linux-$_commit"

prepare() {
    default_prepare
    cp "$srcdir/config-$_flavor.$arch" .config
}

build() {
    unset LDFLAGS
    make -j$(nproc) ARCH="$_carch" CC="${CC:-gcc}" \
        KBUILD_BUILD_VERSION="$((pkgrel + 1))-postmarketOS"
}

package() {
    mkdir -p "$pkgdir"/boot

    # Install modules and DTBs
    make zinstall modules_install dtbs_install \
        ARCH="$_carch" \
	INSTALL_PATH="$pkgdir"/boot/ \
        INSTALL_MOD_PATH="$pkgdir" \
        INSTALL_MOD_STRIP=1 \
        INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs

    rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

    install -D "$builddir/include/config/kernel.release" \
        "$pkgdir"/usr/share/kernel/$_flavor/kernel.release
}

sha512sums="
1006d2fa8fce2a82fd7ee2d85d29712e2afcba49f9976917f3235a3054adf55a147b3b1dd667afda2e15dadcc12c3f799d71e689a9513b8c3a60200a0c0a2376  linux-xiaomi-raphael-acf0a3647abf06f35b9fed72ba5b76309ac2c42c.tar.gz
043878dd1e026f9ced8e9e14abc2d7f871d9aa5067052ce5f496121027e4f24ddadec273982432ffe3964e67f329e6ad31ce0cd8d92823d26349e2c6f4eb7aad  config-xiaomi-raphael.aarch64
"
