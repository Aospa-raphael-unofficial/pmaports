# Maintainer: Piyush Raj Chouhan <piyushchouhan1598@gmail.com>
_flavor="xiaomi-raphael"
pkgname=linux-$_flavor
pkgver=6.17.0
pkgrel=1
pkgdesc="Xiaomi Mi 9T Pro / Redmi K20 Pro kernel fork"
arch="aarch64"
_carch="arm64"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps
    pmb:cross-native
    pmb:kconfigcheck-nftables
    "
makedepends="
    bash
    bison
    findutils
    flex
    linux-headers
    openssl-dev
    perl
    postmarketos-installkernel
    python3
    "

_config="config-$_flavor.$arch"
_commit="936e7ad11614dd61978cd75e30edee2aa761c0a1"
source="
    $pkgname-$_commit.tar.gz::https://github.com/Aospa-raphael-unofficial/linux/archive/$_commit.tar.gz
    $_config
"
builddir="$srcdir/linux-$_commit"

prepare() {
    default_prepare
    cp "$srcdir/config-$_flavor.$arch" .config
}

build() {
    unset LDFLAGS
    make -j$(nproc) ARCH="$_carch" CC="${CC:-gcc}" \
        KBUILD_BUILD_VERSION="$((pkgrel + 1))-postmarketOS"
}

package() {
    mkdir -p "$pkgdir"/boot

    # Install modules and DTBs
    make zinstall modules_install dtbs_install \
        ARCH="$_carch" \
	INSTALL_PATH="$pkgdir"/boot/ \
        INSTALL_MOD_PATH="$pkgdir" \
        INSTALL_MOD_STRIP=1 \
        INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs

    rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

    install -D "$builddir/include/config/kernel.release" \
        "$pkgdir"/usr/share/kernel/$_flavor/kernel.release
}

sha512sums="
56b7f4806b954997cc246500845851ef5e24afef50b4b6c395987e53b0825251887f5a66ff30a52e5709cee9325a31900b0aa8160db3a910016ab49048cf2d04  linux-xiaomi-raphael-936e7ad11614dd61978cd75e30edee2aa761c0a1.tar.gz
54f45ea1e2e9135d1b37cd62644d1d0bcdcb58251bef4c7ea15a41e168692d30a751c06604d03f73349e7673fbdc20c223136925dd0f6e8149bc651651da4662  config-xiaomi-raphael.aarch64
"
